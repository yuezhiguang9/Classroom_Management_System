<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="demo.campus_management_system.dao.dao_interface.TeachSecretaryMapper">

    <!-- 教秘查看审核工作台(分页) -->
    <select id="selectSecLogs" resultType="demo.campus_management_system.entity.VO.ListLogsVO">
        SELECT 
            u.user_name,
            u.user_phone as phone,
            ai.apply_book_time as book_time,
            b.building_name,
            c.room_num,
            cr.res_date as date,
            cr.res_week as week,
            cr.res_day_of_week as day_of_week,
            cr.res_period as period,
            ai.apply_purpose as purpose,
            ai.apply_person_count as person_count,
            ai.apply_status
        FROM apply_info ai
        LEFT JOIN users u ON ai.user_account = u.user_account
        LEFT JOIN classroom_resource cr ON ai.apply_id = cr.apply_info_id
        LEFT JOIN classroom c ON cr.room_num = c.room_num
        LEFT JOIN building b ON c.building_id = b.building_id
        WHERE ai.sec_account = #{secAccount}
            AND ai.user_cancel = 0
        <if test="applyStatus != null and applyStatus != ''">
            AND ai.apply_status = #{applyStatus}
        </if>
        <if test="buildingId != null and buildingId != ''">
            AND c.building_id = #{buildingId}
        </if>
        <if test="userName != null and userName != ''">
            AND u.user_name LIKE CONCAT('%', #{userName}, '%')
        </if>
        <if test="dateStart != null and dateStart != ''">
            AND cr.res_date &gt;= #{dateStart}
        </if>
        <if test="dateEnd != null and dateEnd != ''">
            AND cr.res_date &lt;= #{dateEnd}
        </if>
        ORDER BY ai.apply_book_time DESC
    </select>

    <!-- 教秘今日待审核数 -->
    <select id="countTodayPendingBySec" resultType="Integer">
        SELECT COUNT(*)
        FROM apply_info
        WHERE sec_account = #{secAccount}
            AND apply_status = '未审核'
            AND DATE(apply_book_time) = CURDATE()
            AND user_cancel = 0
    </select>

    <!-- 教秘本周通过数 -->
    <select id="countWeekApprovedBySec" resultType="Integer">
        SELECT COUNT(*)
        FROM apply_info
        WHERE sec_account = #{secAccount}
            AND apply_status = '已通过'
            AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)
            AND user_cancel = 0
    </select>

    <!-- 教秘本周驳回数 -->
    <select id="countWeekRejectedBySec" resultType="Integer">
        SELECT COUNT(*)
        FROM apply_info
        WHERE sec_account = #{secAccount}
            AND apply_status = '已驳回'
            AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)
            AND user_cancel = 0
    </select>

    <!-- 根据申请ID查询详情(过滤用户取消的预约) -->
    <select id="selectSecLogDetail" resultType="demo.campus_management_system.entity.VO.ListLogsVO">
        SELECT 
            u.user_name,
            u.user_phone as phone,
            ai.apply_book_time as book_time,
            b.building_name,
            cr.room_num,
            cr.res_date as date,
            cr.res_week as week,
            cr.res_day_of_week as day_of_week,
            cr.res_period as period,
            ai.apply_purpose as purpose,
            ai.apply_person_count as person_count,
            ai.apply_status
        FROM apply_info ai
        LEFT JOIN users u ON ai.user_account = u.user_account
        LEFT JOIN classroom_resource cr ON ai.apply_id = cr.apply_info_id
        LEFT JOIN classroom c ON cr.room_num = c.room_num
        LEFT JOIN building b ON c.building_id = b.building_id
        WHERE ai.apply_id = #{applyId}
            AND ai.user_cancel = 0
        LIMIT 1
    </select>

    <!-- 更新申请审核状态 -->
    <update id="updateApplyStatus">
        UPDATE apply_info
        SET apply_status = #{applyStatus}
        <if test="rejectReason != null and rejectReason != ''">
            ,apply_reject_reason = #{rejectReason}
        </if>
        WHERE apply_id = #{applyId}
            AND user_cancel = 0
    </update>
    <!-- 查询每个教室的使用情况统计 -->
    <select id="selectUsageStatistics" resultType="demo.campus_management_system.entity.VO.ClassroomUsageVO">
        SELECT
        -- 教室名称（建筑名-房间号）
        CONCAT(b.building_name, '-', c.room_num) as classroom,

        -- 教室类型
        c.room_type as roomType,

        -- 本时段使用次数
        COALESCE(current_usage.usage_count, 0) as usageCount,

        -- 本时段使用率（这里需要根据你的业务逻辑定义）
        -- 假设使用率 = 本时段使用次数 / 本时段总可用时段数 * 100%
        CONCAT(ROUND(
        CASE
        WHEN total_slots.total_count > 0
        THEN COALESCE(current_usage.usage_count, 0) * 100.0 / total_slots.total_count
        ELSE 0
        END, 2
        ), '%') as usageRate,

        -- 较上周变化率
        CASE
        WHEN COALESCE(last_week_usage.usage_count, 0) = 0 AND COALESCE(current_usage.usage_count, 0) > 0
        THEN '+100%'
        WHEN COALESCE(last_week_usage.usage_count, 0) = 0 AND COALESCE(current_usage.usage_count, 0) = 0
        THEN '0%'
        WHEN COALESCE(last_week_usage.usage_count, 0) > 0
        THEN CONCAT(
        CASE
        WHEN (COALESCE(current_usage.usage_count, 0) - COALESCE(last_week_usage.usage_count, 0)) >= 0
        THEN '+'
        ELSE ''
        END,
        ROUND(
        (COALESCE(current_usage.usage_count, 0) - COALESCE(last_week_usage.usage_count, 0)) * 100.0 / last_week_usage.usage_count, 2
        ), '%'
        )
        ELSE '0%'
        END as changeRate

        FROM classroom c
        LEFT JOIN building b ON c.building_id = b.building_id

        -- 本时段使用次数统计
        LEFT JOIN (
        SELECT
        room_num,
        COUNT(*) as usage_count
        FROM classroom_resource
        WHERE res_room_status = '已预订'
        <if test="dateStart != null and dateEnd != null">
            AND DATE(created_time) BETWEEN #{dateStart} AND #{dateEnd}
        </if>
        GROUP BY room_num
        ) current_usage ON c.room_num = current_usage.room_num

        -- 上周同期使用次数统计
        LEFT JOIN (
        SELECT
        room_num,
        COUNT(*) as usage_count
        FROM classroom_resource
        WHERE res_room_status = '已预订'
        <if test="dateStart != null and dateEnd != null">
            AND DATE(created_time) BETWEEN
            DATE_SUB(#{dateStart}, INTERVAL 7 DAY) AND
            DATE_SUB(#{dateEnd}, INTERVAL 7 DAY)
        </if>
        GROUP BY room_num
        ) last_week_usage ON c.room_num = last_week_usage.room_num

        -- 总可用时段数（用于计算使用率）
        LEFT JOIN (
        SELECT
        room_num,
        COUNT(*) as total_count
        FROM classroom_resource
        WHERE 1=1
        <if test="dateStart != null and dateEnd != null">
            AND DATE(created_time) BETWEEN #{dateStart} AND #{dateEnd}
        </if>
        GROUP BY room_num
        ) total_slots ON c.room_num = total_slots.room_num

        WHERE 1=1
        <if test="buildingId != null and buildingId != ''">
            AND c.building_id = #{buildingId}
        </if>
        <if test="roomType != null and roomType != ''">
            AND c.room_type = #{roomType}
        </if>

        ORDER BY COALESCE(current_usage.usage_count, 0) DESC
    </select>

    <!-- 查询教室使用率详细列表(分页) -->
    <select id="selectUsageDetails" resultType="demo.campus_management_system.entity.VO.ClassroomUsageVO">
        SELECT
            CONCAT(b.building_name, '-', c.room_num) as classroom,
            c.room_type,
            COUNT(cr.res_id) as usage_count,
            CONCAT(ROUND(COUNT(cr.res_id) * 100.0 /
                (SELECT COUNT(*) FROM classroom_resource cr2 WHERE cr2.room_num = c.room_num), 2), '%'
            ) as usage_rate,
            '0%' as change_rate
        FROM classroom c
        LEFT JOIN building b ON c.building_id = b.building_id
        LEFT JOIN classroom_resource cr ON c.room_num = cr.room_num
            AND cr.res_room_status = '已预订'
        WHERE 1=1
        <if test="buildingId != null and buildingId != ''">
            AND c.building_id = #{buildingId}
        </if>
        <if test="roomType != null and roomType != ''">
            AND c.room_type = #{roomType}
        </if>
        <choose>
            <when test="timeRange == 'week'">
                AND (cr.res_id IS NULL OR YEARWEEK(cr.res_date, 1) = YEARWEEK(NOW(), 1))
            </when>
            <when test="timeRange == 'month'">
                AND (cr.res_id IS NULL OR (YEAR(cr.res_date) = YEAR(NOW()) AND MONTH(cr.res_date) = MONTH(NOW())))
            </when>
            <when test="timeRange == 'semester'">
                AND (cr.res_id IS NULL OR cr.res_date &gt;= DATE_SUB(NOW(), INTERVAL 6 MONTH))
            </when>
            <otherwise>
                <if test="dateStart != null and dateStart != ''">
                    AND (cr.res_id IS NULL OR cr.res_date &gt;= #{dateStart})
                </if>
                <if test="dateEnd != null and dateEnd != ''">
                    AND (cr.res_id IS NULL OR cr.res_date &lt;= #{dateEnd})
                </if>
            </otherwise>
        </choose>
        GROUP BY c.room_num, c.room_type, b.building_name
        ORDER BY usage_count DESC
    </select>


    <select id="getClassroomUsageStats" resultType="demo.campus_management_system.entity.VO.ClassroomUsageStatsVO">
        SELECT
            (SELECT COUNT(*)
             FROM apply_info
             WHERE apply_status = '已通过'
               AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)
               AND user_cancel = 0)                                   AS this_week_approved,

            (SELECT COUNT(*)
             FROM apply_info
             WHERE apply_status = '已驳回'
               AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)) AS this_week_rejected,

            (SELECT COUNT(*)
             FROM apply_info
             WHERE apply_status = '未审核'
               AND DATE (apply_book_time) = CURDATE()) AS today_pending,

            CASE
            WHEN (
        SELECT COUNT(*)
        FROM apply_info
        WHERE apply_status = '已通过'
          AND DATE (apply_book_time) = CURDATE()
          AND user_cancel = 0) =
            (
        SELECT COUNT(*)
        FROM apply_info
        WHERE apply_status = '已通过'
          AND DATE (apply_book_time) = DATE_SUB(CURDATE()
            , INTERVAL 1 DAY)
          AND user_cancel = 0)
            THEN '与昨日持平'
            WHEN (
        SELECT COUNT(*)
        FROM apply_info
        WHERE apply_status = '已通过'
          AND DATE (apply_book_time) = CURDATE()
          AND user_cancel = 0)
            >
            (
        SELECT COUNT(*)
        FROM apply_info
        WHERE apply_status = '已通过'
          AND DATE (apply_book_time) = DATE_SUB(CURDATE()
            , INTERVAL 1 DAY)
          AND user_cancel = 0)
            THEN CONCAT('较昨日增长'
            , (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已通过'
          AND DATE (apply_book_time) = CURDATE()
          AND user_cancel = 0) -
            (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已通过'
          AND DATE (apply_book_time) = DATE_SUB(CURDATE()
            , INTERVAL 1 DAY)
          AND user_cancel = 0)
            , '个')
            ELSE CONCAT('较昨日减少'
            , (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已通过'
          AND DATE (apply_book_time) = DATE_SUB(CURDATE()
            , INTERVAL 1 DAY)
          AND user_cancel = 0) -
            (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已通过'
          AND DATE (apply_book_time) = CURDATE()
          AND user_cancel = 0)
            , '个')
        END
        AS approved_vs_yesterday,

    CASE
        WHEN (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已驳回' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)) =
             (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已驳回' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1) - 1)
        THEN '与上周持平'
        WHEN (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已驳回' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)) >
             (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已驳回' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1) - 1)
        THEN CONCAT('较上周增长',
                   (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已驳回' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)) -
                   (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已驳回' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1) - 1),
                   '个')
        ELSE CONCAT('较上周减少',
                   (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已驳回' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1) - 1) -
                   (SELECT COUNT(*) FROM apply_info WHERE apply_status = '已驳回' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)),
                   '个')
        END
        AS rejected_vs_last_week,

    CASE
        WHEN (SELECT COUNT(*) FROM apply_info WHERE apply_status = '未审核' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)) =
             (SELECT COUNT(*) FROM apply_info WHERE apply_status = '未审核' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1) - 1)
        THEN '与上周持平'
        WHEN (SELECT COUNT(*) FROM apply_info WHERE apply_status = '未审核' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)) >
             (SELECT COUNT(*) FROM apply_info WHERE apply_status = '未审核' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1) - 1)
        THEN CONCAT('较上周增长',
                   (SELECT COUNT(*) FROM apply_info WHERE apply_status = '未审核' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)) -
                   (SELECT COUNT(*) FROM apply_info WHERE apply_status = '未审核' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1) - 1),
                   '个')
        ELSE CONCAT('较上周减少',
                   (SELECT COUNT(*) FROM apply_info WHERE apply_status = '未审核' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1) - 1) -
                   (SELECT COUNT(*) FROM apply_info WHERE apply_status = '未审核' AND YEARWEEK(apply_book_time, 1) = YEARWEEK(NOW(), 1)),
                   '个')
        END
        AS pending_vs_last_week;
    </select>

    <select id="calculateClassroomMetrics" resultType="demo.campus_management_system.entity.VO.CalculateClassroomMetricsVo">
        WITH classroom_usage AS (
        SELECT
        c.room_num,
        c.room_type,
        c.room_capacity,
        COUNT(cr.res_id) as total_periods,
        SUM(CASE WHEN cr.res_room_status = '已预订' THEN 1 ELSE 0 END) as used_periods,
        CASE
        WHEN COUNT(cr.res_id) > 0 THEN
        ROUND(SUM(CASE WHEN cr.res_room_status = '已预订' THEN 1 ELSE 0 END) * 100.0 / COUNT(cr.res_id), 2)
        ELSE 0
        END as usage_rate
        FROM classroom c
        LEFT JOIN classroom_resource cr ON c.room_num = cr.room_num
        GROUP BY c.room_num, c.room_type, c.room_capacity
        ),

        this_week_usage AS (
        SELECT
        COUNT(CASE WHEN cr.res_room_status = '已预订' THEN 1 END) as this_week_used,
        COUNT(cr.res_id) as this_week_total
        FROM classroom_resource cr
        WHERE YEARWEEK(cr.res_date, 1) = YEARWEEK(CURDATE(), 1)
        ),

        last_week_usage AS (
        SELECT
        COUNT(CASE WHEN cr.res_room_status = '已预订' THEN 1 END) as last_week_used,
        COUNT(cr.res_id) as last_week_total
        FROM classroom_resource cr
        WHERE YEARWEEK(cr.res_date, 1) = YEARWEEK(CURDATE(), 1) - 1
        ),

        week_comparison AS (
        SELECT
        CASE
        WHEN tw.this_week_total > 0 THEN
        ROUND(tw.this_week_used * 100.0 / tw.this_week_total, 2)
        ELSE 0
        END as this_week_rate,
        CASE
        WHEN lw.last_week_total > 0 THEN
        ROUND(lw.last_week_used * 100.0 / lw.last_week_total, 2)
        ELSE 0
        END as last_week_rate
        FROM this_week_usage tw, last_week_usage lw
        ),

        avg_usage AS (
        SELECT AVG(usage_rate) as average_usage_rate
        FROM classroom_usage
        ),

        most_used AS (
        SELECT
        room_num,
        used_periods,
        usage_rate,
        ROW_NUMBER() OVER (ORDER BY used_periods DESC, usage_rate DESC) as rn
        FROM classroom_usage
        ),

        least_used AS (
        SELECT
        room_num,
        used_periods,
        usage_rate,
        ROW_NUMBER() OVER (ORDER BY used_periods ASC, usage_rate ASC) as rn
        FROM classroom_usage
        )

        SELECT
        ROUND(avg.average_usage_rate, 2) as average_usage_rate,
        (SELECT mu.room_num FROM most_used mu WHERE mu.rn = 1) as most_used_classroom,
        (SELECT mu.used_periods FROM most_used mu WHERE mu.rn = 1) as most_used_count,
        (SELECT lu.room_num FROM least_used lu WHERE lu.rn = 1) as least_used_classroom,
        (SELECT lu.used_periods FROM least_used lu WHERE lu.rn = 1) as least_used_count,
        CASE
        WHEN wc.this_week_rate > wc.last_week_rate THEN
        CONCAT('上升 ', ROUND(wc.this_week_rate - wc.last_week_rate, 2), '个百分点')
        WHEN wc.this_week_rate &lt; wc.last_week_rate THEN
                                 CONCAT('下降 ', ROUND(wc.last_week_rate - wc.this_week_rate, 2), '个百分点')
        ELSE '持平'
        END as weekly_comparison
        FROM avg_usage avg, week_comparison wc;
    </select>
</mapper>