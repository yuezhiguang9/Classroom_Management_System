<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="demo.campus_management_system.dao.dao_interface.SuperAdminMapper">

    <!-- 1. 总用户数、教秘数、教室管理员数 -->
    <select id="countTotalUsers" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM users
    </select>

    <select id="countTotalTeachSecs" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM teach_secretary
    </select>

    <select id="countTotalClassroomMgrs" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM classroom_manager
    </select>

    <!-- 2. 活跃用户数（近30天有登录记录的distinct用户） -->
    <select id="countActiveUsers" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT user_account)
        FROM login
        WHERE login_time >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
    </select>

    <!-- 3. 总预约数（apply_info表，支持日期筛选） -->
    <select id="countTotalApplies" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM apply_info
        <where>
            <if test="dateStart != null and dateStart != ''">
                AND apply_book_time >= STR_TO_DATE(#{dateStart}, '%Y-%m-%d')
            </if>
            <if test="dateEnd != null and dateEnd != ''">
                AND apply_book_time &lt;= STR_TO_DATE(#{dateEnd}, '%Y-%m-%d')
            </if>
        </where>
    </select>
    <!-- 4. 经常使用的教室统计（按使用次数排序取前五，仅返回room_num） -->
    <select id="countFrequentlyUsedRooms" resultType="demo.campus_management_system.entity.DTO.AnalyzeDataDTO">
        SELECT
        b.building_name AS building_name,
        cr.room_num AS room_num
        FROM apply_info ai
        INNER JOIN classroom_resource cr ON ai.apply_id = cr.apply_info_id
        INNER JOIN classroom c ON cr.room_num = c.room_num
        INNER JOIN building b ON c.building_id = b.building_id
        <where>
            <if test="dateStart != null and dateStart != ''">
                AND ai.apply_book_time >= STR_TO_DATE(#{dateStart}, '%Y-%m-%d')
            </if>
            <if test="dateEnd != null and dateEnd != ''">
                AND ai.apply_book_time &lt;= STR_TO_DATE(#{dateEnd}, '%Y-%m-%d')
            </if>
        </where>
        GROUP BY b.building_name,cr.room_num
        ORDER BY COUNT(*) DESC
        LIMIT 5  -- 只取前五
    </select>


    <!-- 6. 教室类型分布（按room_type分组统计数量） -->
    <select id="countRoomTypeDistribution" resultType="demo.campus_management_system.entity.DTO.AnalyzeDataDTO">
        SELECT
        c.room_type AS room_type,
        COUNT(*) AS room_type_count
        FROM classroom c
        <where>
            <if test="collegeId != null and collegeId != ''">
                AND c.college_id = #{collegeId}
            </if>
            <if test="buildingId != null and buildingId != ''">
                AND c.building_id = #{buildingId}
            </if>
        </where>
        GROUP BY c.room_type
        ORDER BY room_type_count DESC
    </select>

</mapper>