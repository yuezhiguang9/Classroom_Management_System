<?xml version="1.0" encoding = "UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="demo.campus_management_system.dao.dao_interface.SuperAdminMapper">
    <select id="selectTodayPending">
        select count(*)
        from apply_info
        where apply_book_time = CURRENT_DATE;
    </select>


    <select id="selectWeekApproved" resultType="java.lang.Integer">
        SELECT COUNT(*) AS approved_count
        FROM apply_info
        WHERE apply_book_time between #{StartTime} and #{EndTime}
          AND apply_status = '已批准'
    </select>

    <select id="selectWeekRejected">
        select count(*)
        from apply_info
        where apply_book_time between #{StartTime} and #{EndTime}
          and apply_status = '已拒绝'
    </select>


    <resultMap id="listLogsVOMap" type="demo.campus_management_system.entity.VO.ListLogsVO">
        <result property="user_name" column="user_name"/>
        <result property="phone" column="user_phone"/>
        <result property="book_time" column="apply_book_time"/>
        <result property="building_name" column="building_name"/>
        <result property="room_num" column="room_num"/>
        <result property="date" column="res_date"/>
        <result property="week" column="res_week"/>
        <result property="day_of_week" column="res_day_of_week"/>
        <result property="period" column="res_period"/>
        <result property="purpose" column="apply_purpose"/>
        <result property="person_count" column="apply_person_count"/>
        <result property="apply_status" column="apply_status"/>
    </resultMap>

    <select id="selectRecordsByPage" resultMap="listLogsVOMap">
        SELECT
        users.user_name,
        users.user_phone,
        apply_book_time,
        building_name,
        classroom.room_num,
        res_date,
        res_week,
        res_day_of_week,
        res_period,
        apply_purpose,
        apply_person_count,
        apply_status
        from users,
        apply_info,
        classroom_resource,
        classroom,
        building,
        college
        where users.user_account = apply_info.user_account
        and apply_info.apply_id = classroom_resource.apply_info_id
        and classroom_resource.room_num = classroom.room_num
        and classroom.building_id = building.building_id
        and users.college_id = college.college_id
        <if test="apply_status != null and apply_status != ''">
            AND apply_info.apply_status = #{apply_status}
        </if>
        <if test="college_id != null and college_id != ''">
            AND users.college_id = #{college_id}
        </if>
        <if test="building_id != null and building_id != ''">
            AND building.building_id = #{building_id}
        </if>
        <if test="user_name != null and user_name != ''">
            AND users.user_name LIKE CONCAT('%', #{user_name}, '%')
        </if>
        <if test="date_start != null and date_start != '' and date_end != null and date_end != ''">
            AND classroom_resource.res_date BETWEEN #{date_start} AND #{date_end}
        </if>
        <if test="(date_start != null and date_start != '') and (date_end == null or date_end == '')">
            AND classroom_resource.res_date >= #{date_start}
        </if>
        <if test="(date_start == null or date_start == '') and (date_end != null and date_end != '')">
            AND classroom_resource.res_date &lt;= #{date_end}
        </if>
    </select>

    <select id="selectSuperAdmin">
        select case when count(*) > 0 then true else false end
        from super_admin
        where account = #{account}
          and password = #{password}
    </select>

    <update id="editUsers" parameterType="demo.campus_management_system.entity.DTO.UpdateUsersDTO">
        UPDATE users
        <set>
            <if test="account != null and account != ''">
                user_account= #{account},
            </if>
            <if test="name != null and name != ''">
                user_name = #{name},
            </if>
            <if test="password != null and password != ''">
                user_password = #{password},
            </if>
            <if test="phone != null and phone != ''">
                user_phone = #{phone},
            </if>
            <if test="college_id != null and college_id != ''">
                college_id = #{college_id},
            </if>
        </set>
        WHERE user_account = #{account}
    </update>

    <update id="editTeach" parameterType="demo.campus_management_system.entity.DTO.UpdateUsersDTO">
        UPDATE teach_secretary
        <set>
            <if test="account != null and account != ''">
                sec_account= #{account},
            </if>
            <if test="name != null and name != ''">
                sec_name = #{name},
            </if>
            <if test="password != null and password != ''">
                sec_password = #{password},
            </if>
            <if test="phone != null and phone != ''">
                office_phone = #{phone},
            </if>
            <if test="college_id != null and college_id != ''">
                college_id = #{college_id},
            </if>
        </set>
        WHERE sec_account = #{account}
    </update>


    <update id="editClassMgr" parameterType="demo.campus_management_system.entity.DTO.UpdateUsersDTO">
        UPDATE classroom_manager
        <set>
            <if test="account != null and account != ''">
                mgr_account= #{account},
            </if>
            <if test="password != null and password != ''">
                mgr_password = #{password},
            </if>
            <if test="phone != null and phone != ''">
                mgr_phone = #{phone},
            </if>
            <if test="building_id != null and building_id != ''">
                building_id = #{building_id},
            </if>
        </set>
        WHERE mgr_account = #{account}
    </update>


</mapper>