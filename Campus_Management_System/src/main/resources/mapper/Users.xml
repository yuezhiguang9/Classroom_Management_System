<?xml version="1.0" encoding = "UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="demo.campus_management_system.dao.dao_interface.UsersMapper">

    <resultMap id="selectClassroom" type="demo.campus_management_system.entity.DTO.SelectClassroomDTO">
        <result property="building_name" column="building_name"/>
        <result property="room_num" column="room_num"/>
        <result property="capacity" column="room_capacity"/>
        <result property="room_type" column="room_type"/>
        <result property="res_week" column="res_week"/>
        <result property="res_day_of_week" column="res_day_of_week"/>
        <result property="room_status" column="res_room_status"/>
        <result property="res_date" column="res_date"/>
        <result property="period" column="periods"
                typeHandler="demo.campus_management_system.util.StringToListTypeHandler"/>
    </resultMap>

    <select id="selectClassroom" resultMap="selectClassroom">
        select
        building.building_name,
        classroom.room_num,
        classroom.room_capacity,
        classroom.room_type,
        classroom_resource.res_week,
        classroom_resource.res_day_of_week,
        CASE
        WHEN MAX(CASE WHEN classroom_resource.res_room_status = '不可用' THEN 1 ELSE 0 END) = 1
        THEN '不可用'
        WHEN MAX(CASE WHEN classroom_resource.res_room_status = '已预约' THEN 1 ELSE 0 END) = 1
        THEN '已预约'
        ELSE '空闲'
        END as res_room_status,
        DATE(classroom_resource.res_date) as res_date,
        GROUP_CONCAT(
        DISTINCT CASE WHEN classroom_resource.res_room_status = '空闲' THEN classroom_resource.res_period END
        ORDER BY
        CASE
        WHEN classroom_resource.res_period LIKE '%第一节%' THEN 1
        WHEN classroom_resource.res_period LIKE '%第二节%' THEN 2
        WHEN classroom_resource.res_period LIKE '%第三节%' THEN 3
        WHEN classroom_resource.res_period LIKE '%第四节%' THEN 4
        WHEN classroom_resource.res_period LIKE '%第五节%' THEN 5
        WHEN classroom_resource.res_period LIKE '%第六节%' THEN 6
        WHEN classroom_resource.res_period LIKE '%第七节%' THEN 7
        WHEN classroom_resource.res_period LIKE '%第八节%' THEN 8
        WHEN classroom_resource.res_period LIKE '%第九节%' THEN 9
        WHEN classroom_resource.res_period LIKE '%第十节%' THEN 10
        ELSE 99
        END
        SEPARATOR ','
        ) AS periods
        from classroom
        inner join classroom_resource on classroom.room_num = classroom_resource.room_num
        inner join building on classroom.building_id = building.building_id
        <where>
            <!-- 移除注释，确保条件正确拼接 -->
            <if test="building_id != null and building_id != ''">
                building.building_id = #{building_id}
            </if>
            <if test="capacity != null">
                AND classroom.room_capacity >= #{capacity}
            </if>
            <if test="room_type != null and room_type != ''">
                AND classroom.room_type = #{room_type}
            </if>
            <if test="res_week != null and res_week != ''">
                AND classroom_resource.res_week = #{res_week}
            </if>
            <if test="res_day_of_week != null and res_day_of_week != ''">
                AND classroom_resource.res_day_of_week = #{res_day_of_week}
            </if>
            <if test="period != null and period != ''">
                AND classroom_resource.res_period = #{period}
            </if>
            <if test="room_status != null and room_status != ''">
                AND classroom_resource.res_room_status = #{room_status}
            </if>
            <if test="date != null and date != ''">
                and DATE(classroom_resource.res_date) = DATE(#{date})
            </if>
        </where>
        <!-- 确保GROUP BY前没有多余的WHERE -->
        GROUP BY DATE(classroom_resource.res_date), classroom.room_num, building.building_name, classroom.room_capacity,
        classroom.room_type,
        classroom_resource.res_week,
        classroom_resource.res_day_of_week
    </select>


    <!--    //预约教室部分-->
    <!--    查询选中的教室资源是不是空闲状态-->
    <select id="selectRoomStatus">
        select classroom_resource.res_room_status
        from classroom_resource
        where res_date = #{date}
          and res_period = #{period}
          and room_num = #{room_num}
    </select>


    <!-- 通过用户账号查找教秘 -->
    <select id="selectSecAccountByUser" resultType="java.lang.String">
        SELECT teach_secretary.sec_account
        FROM users
        INNER JOIN college ON users.college_id = college.college_id
        INNER JOIN teach_secretary ON teach_secretary.college_id = college.college_id
        WHERE users.user_account = #{user_account}
        LIMIT 1  <!-- 确保返回单条结果 -->
    </select>

    <!--    登记预约信息-->
    <insert id="submitClassroomApply">
        insert into apply_info(apply_id, apply_person_count, apply_purpose, apply_book_time, apply_status,
                               apply_reject_reason, user_account, sec_account, user_cancel)
        values (#{apply_id}, #{person_count}, #{purpose}, #{apply_book_time}, "待审核", "", #{user_account},
                #{sec_account}, 0)
    </insert>

    <update id="updateRes">
        update classroom_resource
        set apply_info_id   = #{apply_id},
            res_room_status = "已预约"
        where res_date = #{date}
          and res_period = #{period}
          and room_num = #{room_num}

    </update>
    <!--    预约教室end-->


    <!--    查看个人预约记录-->
    <!--    本周预约数-->
    <select id="selectUserWeelTotal">
        select count(*)
        from apply_info
        where user_account = #{user_id}
          and (apply_book_time between #{StartTime} and #{EndTime})
    </select>

    <!--    我的待审核数-->
    <select id="selectMyPending">
        select count(*)
        from apply_info
        where user_account = #{user_id}
          and apply_status = "待审核"
    </select>

    <!--    需要分页的地方-->
    <resultMap id="MyReservationsVO" type="demo.campus_management_system.entity.VO.myReservationsVO">
        <result property="apply_id" column="apply_id"/>
        <result property="building_name" column="building_name"/>
        <result property="room_num" column="room_num"/>
        <result property="date" column="res_date"/>
        <result property="week" column="res_week"/>
        <result property="res_day_of_week" column="res_day_of_week"/>
        <result property="period" column="res_period"/>
        <result property="purpose" column="apply_purpose"/>
        <result property="reject_reason" column="apply_reject_reason"/>
        <result property="book_time" column="apply_book_time"/>
        <result property="apply_status" column="apply_status"/>
        <result property="can_cancel" column="user_cancel"/>
    </resultMap>
    <select id="selectMyReservationsVO" resultMap="MyReservationsVO">
        select apply_info.apply_id,
               building_name,
               classroom.room_num,
               classroom_resource.res_date,
               res_week,
               res_day_of_week,
               res_period,
               apply_purpose,
               apply_reject_reason,
               apply_book_time,
               apply_status,
               user_cancel
        from apply_info,
             classroom,
             classroom_resource,
             building
        where apply_info.apply_id = classroom_resource.apply_info_id
          and classroom_resource.room_num = classroom.room_num
          and classroom.building_id = building.building_id
          and user_account = #{user_id}
    </select>
    <!--    END查看个人记录-->


    <!--    取消预约-->
    <update id="updateApplyInfoCancel" parameterType="String">
        update apply_info
        set user_cancel = "2"
        where apply_id = #{applyId};
    </update>

    <update id="updateClassroomResource" parameterType="String">
        update classroom_resource
        set apply_info_id   = null,
            res_room_status = "空闲"
        where apply_info_id = #{applyId};
    </update>


    <!--    END取消预约-->


</mapper>